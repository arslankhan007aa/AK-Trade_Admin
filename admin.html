<!DOCTYPE html>
<html>
<head>
<title>AK Trade Admin ‚Äî Final Working System</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{
  background: linear-gradient(180deg,#3F0000,#000);
  color:#fff;
  font-family:sans-serif;
  margin:0;
  padding-bottom:90px;
}

/* Card / Box */
.box{
  background:rgba(0,0,0,0.45);
  backdrop-filter:blur(6px);
  padding:20px;
  border-radius:14px;
  margin:15px;
  box-shadow:0 0 12px #FF000055;
}

/* Inputs */
input, select{
  width:100%;
  padding:12px;
  border-radius:10px;
  border:1px solid #FF0000;
  background:#1F0000;
  color:#fff;
  margin-top:10px;
}

/* Buttons */
button{
  width:100%;
  padding:12px;
  background:#FF0000;
  color:#fff;
  border:none;
  border-radius:10px;
  margin-top:10px;
  font-size:17px;
  font-weight:600;
  box-shadow:0 0 10px #FF0000AA;
}
.approve-btn { background:#00AA00; box-shadow:0 0 10px #00AA00AA; margin-top:5px; }
.reject-btn { background:#880000; box-shadow:0 0 10px #880000AA; margin-top:5px; }

h2{ 
  color:#FF4444; 
  font-weight:700;
}

/* Navigation Buttons */
.nav-btn-container {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-top: 15px;
}
.nav-btn-container button {
    flex-grow: 1;
    min-width: 150px;
    padding: 10px;
    margin: 0;
    font-size: 14px;
}

/* Data List Styling */
.data-list {
    list-style: none;
    padding: 0;
}
.data-list li {
    background: #1F0000;
    padding: 15px;
    border-radius: 10px;
    margin-bottom: 10px;
    border-left: 5px solid #FF0000;
}

/* Screenshot styling */
.screenshot-container {
    margin-top: 10px;
    padding: 10px;
    background: #000;
    border-radius: 8px;
    text-align: center;
}
.screenshot-container img {
    max-width: 100%;
    max-height: 200px;
    display: block;
    margin: 5px auto;
    border: 2px solid #FF4444;
}

/* Bottom Navbar */
nav{
text-align:center;
padding:18px 0;
background:#000;
position:fixed;
bottom:0;
left:0;
right:0;
z-index:999;
box-shadow:0 -3px 10px #FF000055;
}
nav a{
color:#FF4444;
margin:0 14px;
font-size:18px;
text-decoration:none;
font-weight:600;
}
nav .logoutBtn{
  color:#fff;
  background:#FF0000;
  padding:6px 12px;
  border-radius:8px;
}
.hidden{ display:none; }
</style>
</head>
<body onload="checkLoginStatus()">

<h1 style="text-align:center; color:#FF4444;">AK Trade Admin üïµÔ∏è</h1>

<div id="adminLoginPage">
  <div class="box">
    <h2>Admin Login üîê</h2>
    <input id="adminUser" placeholder="Username" value="arslankhan007">
    <input id="adminPass" placeholder="Password" type="password" value="arslankhan007">
    <button onclick="adminLogin()">Login</button>
  </div>
</div>

<div id="adminDashboard" class="hidden">

  <div class="box">
    <h2>Admin Navigation</h2>
    <div class="nav-btn-container">
      <button onclick="showSection('counts')">üìä Counts</button>
      <button onclick="showSection('allUsers')">üßë‚Äçüíª All Users</button>
      <button onclick="showSection('pendingDeposits')">üí∏ Pending Deposits</button>
      <button onclick="showSection('pendingWithdraws')">üèß Pending Withdrawals</button>
    </div>
  </div>

  <div id="counts" class="box hidden">
    <h2>üìä System Counts</h2>
    <p>Total Users: <b id="totalUsersCount">0</b></p>
    <p>Total Pending Deposits: <b id="pendingDepCount">0</b></p>
    <p>Total Pending Withdrawals: <b id="pendingWidCount">0</b></p>
  </div>

  <div id="allUsers" class="box hidden">
    <h2>üßë‚Äçüíª All User Details</h2>
    <ul id="allUsersList" class="data-list">
      <li>Loading user data...</li>
    </ul>
  </div>

  <div id="pendingDeposits" class="box hidden">
    <h2>üí∏ Pending Deposits (Plans)</h2>
    <p style="color:yellow;">**Fix:** Payment proof ab image ke taur par Local Storage se load ho raha hai.</p>
    <ul id="pendingDepositsList" class="data-list">
      <li>No pending deposits.</li>
    </ul>
  </div>

  <div id="pendingWithdraws" class="box hidden">
    <h2>üèß Pending Withdrawals</h2>
    <ul id="pendingWithdrawsList" class="data-list">
      <li>No pending withdrawals.</li>
    </ul>
  </div>

</div>

<nav id="adminNavBar" class="hidden">
  <a onclick="showSection('counts')">Home</a>
  <a onclick="adminLogout()" class="logoutBtn">Logout</a>
</nav>


<script>
// --- ADMIN CONFIG ---
const ADMIN_USER = "arslankhan007";
const ADMIN_PASS = "arslankhan007";

/* ================== HELPER FUNCTIONS ================== */
function getAllUsersData(){
  let users = [];
  for(let i = 0; i < localStorage.length; i++){
    let key = localStorage.key(i);
    if(key.startsWith("user_") && key !== ("user_" + ADMIN_USER)){
      let username = key.substring(5);
      let userData = JSON.parse(localStorage.getItem(key));
      users.push({username: username, ...userData});
    }
  }
  return users;
}

// Function to get withdrawal requests from Local Storage
function getWithdrawalRequests(){
    return JSON.parse(localStorage.getItem("withdrawalRequests") || "[]");
}

// Function to save withdrawal requests back to Local Storage
function saveWithdrawalRequests(requests){
    localStorage.setItem("withdrawalRequests", JSON.stringify(requests));
}


/* ================== INITIAL CHECK ================== */
function checkLoginStatus() {
    if (localStorage.getItem("isAdminLoggedIn") === "true") {
        loadDashboard();
    } else {
        // Show login page
        document.getElementById("adminLoginPage").classList.remove("hidden");
        document.getElementById("adminDashboard").classList.add("hidden");
        document.getElementById("adminNavBar").classList.add("hidden");
    }
}

/* ================== ADMIN LOGIN ================== */
function adminLogin(){
  let adminUser = document.getElementById("adminUser");
  let adminPass = document.getElementById("adminPass");
  let u = adminUser.value.trim();
  let p = adminPass.value.trim();

  if(u === ADMIN_USER && p === ADMIN_PASS){
    localStorage.setItem("isAdminLoggedIn", "true");
    loadDashboard();
  } else {
    alert("Invalid Admin Credentials");
  }
}

/* ================== LOAD ADMIN DASHBOARD ================== */
function loadDashboard(){
  document.getElementById("adminLoginPage").classList.add("hidden");
  document.getElementById("adminDashboard").classList.remove("hidden");
  document.getElementById("adminNavBar").classList.remove("hidden");
  
  // Default to Pending Deposits first.
  showSection("pendingDeposits");
}

/* ================== SHOW SECTIONS ================== */
function showSection(sec){
  // Hide all content boxes
  ["counts","allUsers","pendingDeposits","pendingWithdraws"].forEach(id=>{
    document.getElementById(id).classList.add("hidden");
  });
  
  // Show the requested section
  document.getElementById(sec).classList.remove("hidden");

  // Load data specific to the section
  if (sec === 'counts') loadCounts();
  if (sec === 'allUsers') displayAllUsers();
  if (sec === 'pendingDeposits') displayPendingDeposits();
  if (sec === 'pendingWithdraws') displayPendingWithdrawals();
}

/* ================== LOAD COUNTS ================== */
function loadCounts(){
    let usersData = getAllUsersData();
    let totalUsers = usersData.length;
    let withdrawalRequests = getWithdrawalRequests();

    // Check for the new 'pendingDeposit' object
    let pendingDeps = usersData.filter(u => u.pendingDeposit).length; 
    
    let pendingWids = withdrawalRequests.filter(w => w.status === 'Pending').length;

    document.getElementById('totalUsersCount').innerHTML = totalUsers;
    document.getElementById('pendingDepCount').innerHTML = pendingDeps;
    document.getElementById('pendingWidCount').innerHTML = pendingWids;
}


/* ================== DISPLAY ALL USERS ================== */
function displayAllUsers(){
  let usersList = document.getElementById("allUsersList");
  usersList.innerHTML = "";
  let usersData = getAllUsersData();

  if(usersData.length === 0){
    usersList.innerHTML = "<li>No regular users found in Local Storage.</li>";
    return;
  }

  usersData.forEach(userData => {
      let listItem = document.createElement("li");
      listItem.innerHTML = `
        <strong>Username: ${userData.username}</strong><br>
        Balance: ${userData.bal} Rs | Ref by: ${userData.ref || 'None'}<br>
        Active Plan: ${userData.plan || 'None'} (Daily: ${userData.daily} Rs)<br>
        Plan Expiry: ${userData.planExpiry || '‚Äî'}<br>
        <span style="color:yellow;">Deposit Pending: ${userData.pendingDeposit ? 'Yes' : 'No'}</span><br>
        Last Task: ${userData.lastTaskDay || 'Never'} (Done Today: ${userData.tasksDone})
      `;
      usersList.appendChild(listItem);
  });
}

/* ================== DISPLAY PENDING DEPOSITS ================== */
function displayPendingDeposits(){
  let depositsList = document.getElementById("pendingDepositsList");
  depositsList.innerHTML = "";
  let usersData = getAllUsersData();
  let pendingCount = 0;

  usersData.forEach(userData => {
      // Check for the new pendingDeposit object
      if(userData.pendingDeposit){
        let dep = userData.pendingDeposit;
        let listItem = document.createElement("li");
        
        listItem.innerHTML = `
          User: <strong>${userData.username}</strong> (${dep.date})<br>
          Plan: ${dep.plan}<br>
          Amount: <b>${dep.amount} Rs</b> (Via ${dep.method})<br>
          
          <div class="screenshot-container">
            Payment Proof:<br>
            <img src="${dep.screenshot}" alt="Payment Screenshot">
          </div>

          <button class="approve-btn" onclick="approvePlan('${userData.username}')">Approve Plan</button>
          <button class="reject-btn" onclick="rejectPlan('${userData.username}')">Reject Deposit</button>
        `;
        depositsList.appendChild(listItem);
        pendingCount++;
      }
  });

  if(pendingCount === 0){
    depositsList.innerHTML = "<li>No pending deposits.</li>";
  }
}

/* ================== APPROVE PLAN ================== */
function approvePlan(username){
  let key = "user_" + username;
  let userData = JSON.parse(localStorage.getItem(key));
  
  if(userData.pendingDeposit){
    // Set adminApproved flag so client script activates the plan on next load
    userData.adminApproved = true; 
    
    // Save updated user data
    localStorage.setItem(key, JSON.stringify(userData));
    alert("Deposit Approved! User's plan will activate on next login/refresh.");
    loadDashboard();
  }
}

/* ================== REJECT PLAN ================== */
function rejectPlan(username){
  let key = "user_" + username;
  let userData = JSON.parse(localStorage.getItem(key));
  
  if(userData.pendingDeposit){
    // Delete the pending deposit object, user will have to select plan and deposit again
    delete userData.pendingDeposit;
    userData.adminApproved = false;
    
    localStorage.setItem(key, JSON.stringify(userData));
    alert("Deposit Rejected for " + username + ".");
    loadDashboard();
  }
}

/* ================== DISPLAY PENDING WITHDRAWALS ================== */
function displayPendingWithdrawals(){
    let withdrawsList = document.getElementById("pendingWithdrawsList");
    withdrawsList.innerHTML = "";
    let withdrawalRequests = getWithdrawalRequests();
    let pendingWids = withdrawalRequests.filter(w => w.status === 'Pending');

    if(pendingWids.length === 0){
        withdrawsList.innerHTML = "<li>No pending withdrawals.</li>";
        return;
    }

    pendingWids.forEach(wid => {
        let listItem = document.createElement("li");
        listItem.innerHTML = `
            User: <strong>${wid.user}</strong> | Amount: **${wid.amount} Rs**<br>
            Method: ${wid.type} | Account: ${wid.number}<br>
            Name: ${wid.name} | Time: ${wid.timestamp}<br>
            <button class="approve-btn" onclick="completeWithdraw(${wid.id}, 'Completed')">Complete Payout</button>
            <button class="reject-btn" onclick="completeWithdraw(${wid.id}, 'Rejected')">Reject Payout</button>
        `;
        withdrawsList.appendChild(listItem);
    });
}

/* ================== COMPLETE WITHDRAWAL ================== */
function completeWithdraw(id, status){
    let withdrawalRequests = getWithdrawalRequests();
    let index = withdrawalRequests.findIndex(w => w.id === id);
    
    if(index > -1){
        withdrawalRequests[index].status = status;
        saveWithdrawalRequests(withdrawalRequests);
        alert(`Withdrawal ${status} for User: ${withdrawalRequests[index].user}`);
        loadDashboard();
    }
}


/* ================== LOGOUT ================== */
function adminLogout(){
  localStorage.removeItem("isAdminLoggedIn");
  location.reload();
}
</script>

</body>
</html>
